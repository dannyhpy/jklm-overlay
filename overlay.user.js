// ==UserScript==
// @name        dannyhpy's JKLM.FUN Overlay
// @namespace   mailto:dannyhpy@disroot.org
// @match       https://jklm.fun/*
// @match       https://*.jklm.fun/games/*
// @run-at      document-start
// @grant       GM_registerMenuCommand
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_addStyle
// @version     0.1.3
// @author      dannyhpy
// @description dannyhpy's JKLM.FUN Overlay
// ==/UserScript==

!function e(t,n,o){function a(s,i){if(!n[s]){if(!t[s]){var c="function"==typeof require&&require;if(!i&&c)return c(s,!0);if(r)return r(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var d=n[s]={exports:{}};t[s][0].call(d.exports,(function(e){return a(t[s][1][e]||e)}),d,d.exports,e,t,n,o)}return n[s].exports}for(var r="function"==typeof require&&require,s=0;s<o.length;s++)a(o[s]);return a}({1:[function(e,t,n){const o=e("./ChatEntry"),a=document.createElement("template");a.innerHTML='\n  <div class="chat">\n    <slot></slot>\n  </div>\n\n  <style>\n    .chat {\n      display: flex;\n      flex-direction: column;\n      width: calc(100% - 1rem);\n      height: calc(100% - 1rem);\n    }\n\n    .chat.disabled { filter: grayscale(1); }\n  </style>\n';class r extends HTMLElement{#e;static get observedAttributes(){return["disabled"]}constructor(){super(),this.maxEntryCount=200;const e=this.attachShadow({mode:"closed"}),t=a.content.cloneNode(!0);this.#e=t.querySelector(".chat"),e.append(t)}attributeChangedCallback(e){if("disabled"===e)this.disabled?this.#e.classList.add("disabled"):this.#e.classList.remove("disabled")}appendEntry(e){if(e instanceof o)return this.childElementCount>=this.maxEntryCount&&this.removeChild(this.firstChild),this.appendChild(e)}get disabled(){return this.hasAttribute("disabled")}set disabled(e){e?this.setAttribute("disabled",""):this.removeAttribute("disabled")}}t.exports=r},{"./ChatEntry":2}],2:[function(e,t,n){const o=document.createElement("template");o.innerHTML='\n  <div class="entry">\n  </div>\n\n  <style>\n    :host {\n      --color: #ccc;\n      --bg-color: #333;\n      --bg-hover-color: #444;\n      --font-size: smaller;\n    }\n\n    .entry {\n      background: var(--bg-color);\n      color: var(--color);\n      font-size: var(--font-size);\n      margin: 0.25rem;\n      margin-bottom: 0;\n      padding: 0.5rem;\n      border-radius: 1rem;\n      width: calc(100% - 0.5rem);\n      animation: fade-in 0.2s;\n      transition: background 0.2s;\n    }\n\n    .entry:hover {\n      background: var(--bg-hover-color);\n    }\n\n    @keyframes fade-in {\n      0% { opacity: 0; transform: translateX(-100%) }\n      100% { opacity: 1; transform: none }\n    }\n  </style>\n';class a extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"});const e=o.content.cloneNode(!0);this.entry=e.querySelector(".entry"),this.shadowRoot.append(e)}}t.exports=a},{}],3:[function(e,t,n){const o=document.createElement("template");o.innerHTML='\n  <div class="chat-input">\n    <textarea></textarea>\n    <div class="chat-buttons">\n      <button class="send">ðŸ“¤</button>\n      <button class="boom">ðŸ’¥</button>\n    </div>\n  </div>\n  <div class="chat-footer">\n    <div class="char-count">0/0</div>\n  </div>\n\n  <style>\n    :host {\n      --bg-color: #333;\n      --bg-hover-color: #444;\n      --color: #ccc;\n    }\n\n    .chat-input {\n      display: flex;\n      width: calc(100% - 1rem);\n      height: calc(100% - 1.5rem);\n      margin: 0.5rem 0.5rem 0 0.5rem;\n      border-radius: 1rem;\n    }\n\n    textarea {\n      flex: 1;\n      resize: none;\n      padding: 0.5rem;\n      font-family: sans-serif;\n      font-size: 1rem;\n      color: var(--color);\n      border: none;\n      outline: none;\n      border-radius: 1rem 0 0 1rem;\n      scrollbar-width: none;\n    }\n\n    textarea::-webkit-scrollbar {\n      display: none;\n    }\n\n    .chat-buttons {\n      width: 3rem;\n      margin-left: 0.25rem;\n      border-radius: 0 1rem 1rem 0;\n      display: flex;\n      flex-direction: column;\n    }\n\n    textarea, .chat-buttons {\n      background: var(--bg-color);\n      transition: background 0.2s;\n    }\n\n    .chat-input:not(.disabled):hover textarea,\n    .chat-input:not(.disabled):hover .chat-buttons {\n      background: var(--bg-hover-color);\n    }\n\n    .chat-buttons button {\n      all: unset;\n      flex: 1;\n      text-align: center;\n      border-radius: 0 1rem 1rem 0;\n      transition: background 0.2s;\n    }\n\n    .chat-buttons button:not(:disabled):hover {\n      background: var(--bg-color);\n    }\n\n    .chat-buttons button:disabled {\n      filter: grayscale(1);\n    }\n\n    .chat-footer {\n      margin: 0 0.5rem 0.5rem 0.5rem;\n    }\n\n    .chat-footer .char-count {\n      font-size: 0.75rem;\n      padding-right: 0.5rem;\n      text-align: right;\n      color: var(--color);\n    }\n\n    .chat-input.disabled .char-count {\n      display: none;\n    }\n  </style>\n';class a extends HTMLElement{#t;#n;#o;#a;#r;static get observedAttributes(){return["disabled","maxlength","placeholder","disabled-placeholder"]}constructor(){super();const e=this.attachShadow({mode:"closed"}),t=o.content.cloneNode(!0);this.#t=t.querySelector(".chat-input"),this.#n=t.querySelector("textarea"),this.#o=t.querySelector(".char-count"),this.#a=t.querySelector("button.send"),this.#r=t.querySelector("button.boom"),this.#n.addEventListener("input",(()=>{this.#s()})),this.#n.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.submit()),e.stopPropagation()})),this.#a.addEventListener("click",(e=>{e.preventDefault(),this.submit()})),this.#r.addEventListener("click",(e=>{e.preventDefault(),this.#n.value=this.#r.textContent,this.#s()})),e.append(t)}attributeChangedCallback(e){switch(e){case"disabled":const e=this.disabled;e?(this.#t.classList.add("disabled"),this.#n.value=""):this.#t.classList.remove("disabled"),this.#n.disabled=e,this.#a.disabled=e,this.#r.disabled=e,this.#i();break;case"maxlength":this.#n.maxLength=this.maxLength,this.#s();break;case"disabled-placeholder":case"placeholder":this.#i()}}submit(){this.dispatchEvent(new CustomEvent("submit",{detail:{value:this.#n.value}})),this.#n.value="",this.#s()}#s(){this.#o.textContent=`${this.#n.value.length}/${this.maxLength}`}#i(){this.disabled?this.#n.placeholder=this.disabledPlaceholder??"Chat is disabled.":null!=this.placeholder?this.#n.placeholder=this.placeholder:this.#n.removeAttribute("placeholder")}get disabled(){return this.hasAttribute("disabled")}set disabled(e){e?this.setAttribute("disabled",""):this.removeAttribute("disabled")}get disabledPlaceholder(){return this.getAttribute("disabled-placeholder")}set disabledPlaceholder(e){return this.setAttribute("disabled-placeholder",e)}get maxLength(){if(this.hasAttribute("maxLength"))return parseInt(this.getAttribute("maxLength"))}set maxLength(e){"number"==typeof e?this.setAttribute("maxLength",e.toString()):null==e&&this.removeAttribute("maxLength")}get placeholder(){return this.getAttribute("placeholder")}set placeholder(e){return this.setAttribute("placeholder",e)}get value(){return this.#n.value}}t.exports=a},{}],4:[function(e,t,n){const o=e("./ChatEntry"),a=document.createElement("template"),r=document.createElement("template");a.innerHTML='\n  <div class="left">\n    <div class="picture"><img></div>\n  </div>\n  <div class="right">\n    <div class="author">\n      <div class="nickname"></div>\n      <div class="roles"></div>\n    </div>\n    <div class="messages"></div>\n  </div>\n',r.innerHTML="\n  <style>\n    .entry { display: flex; }\n    .left { margin-right: 0.5rem; }\n    .right { flex: 1; }\n\n    .picture {\n      width: 2.5rem;\n      height: 2.5rem;\n    }\n    .picture img {\n      background-color: #222;\n      border-radius: 50%;\n      height: 2.5rem;\n    }\n\n    .author { display: flex; }\n    .author .nickname {\n      color: white;\n      min-height: 1rem;\n    }\n    .author.banned .nickname {\n      color: #ffadad;\n      text-decoration: line-through;\n    }\n    .author .roles {\n      flex: 1;\n      text-align: right;\n    }\n    .author.banned .roles { display: none; }\n\n    .picture img, .nickname { cursor: pointer; }\n\n    .message {\n      white-space: pre-line;\n      word-break: break-word;\n      animation: fade-in 0.2s;\n    }\n    .message.deleted { font-size: 0; }\n    .message.deleted:before {\n      font-size: small;\n      content: '(deleted)';\n      color: #888;\n    }\n  </style>\n";t.exports=class extends o{#c=null;#l=null;#d=null;#u=null;#h=null;constructor(e,t){super(),this.profile=e;const n=a.content.cloneNode(!0),o=r.content.cloneNode(!0);function s(t){t.preventDefault(),showUserProfile(e.peerId)}this.#c=n.querySelector(".author"),this.#l=n.querySelector(".author .nickname"),this.#l.textContent=e.nickname,this.#d=n.querySelector(".author .roles"),"undefined"!=typeof badgesByRole&&(this.#d.textContent=e.roles.map((e=>badgesByRole[e].icon)).join(" ")),this.#u=n.querySelector(".picture img"),this.#u.src=t?`data:image;base64,${t}`:"/images/auth/guest.png",this.#h=n.querySelector(".messages"),this.#l.addEventListener("click",s),this.#u.addEventListener("click",s),this.entry.append(n),this.shadowRoot.append(o)}appendMessgae(e){const t=document.createElement("div");return t.classList.add("message"),t.textContent=e,this.#h.appendChild(t),{delete(){t.classList.add("deleted")},undelete(){t.classList.remove("deleted")}}}get bannedAuthor(){return this.#c.classList.contains("banned")}set bannedAuthor(e){e?this.#c.classList.add("banned"):this.#c.classList.remove("banned")}}},{"./ChatEntry":2}],5:[function(e,t,n){const o=e("./ChatEntry");t.exports=class extends o{#m;constructor(){super(),this.#m=document.createTextNode(""),this.entry.append(this.#m)}set textContent(e){this.#m.textContent=e}}},{"./ChatEntry":2}],6:[function(e,t,n){const o={autoReconnect:e("./modules/auto-reconnect"),baseTheme:e("./modules/base-theme"),customChat:e("./modules/custom-chat/main"),halloweenTheme:e("./modules/halloween-theme"),historyStates:e("./modules/history-states"),pictureMap:e("./modules/picture-map")};Promise.all([o.autoReconnect.main(),o.baseTheme.main(),o.customChat.main(),o.halloweenTheme.main(),o.historyStates.main(),o.pictureMap.main()]).then((function(){console.warn("Main function exited.")})).catch((function(e){console.error(e)}))},{"./modules/auto-reconnect":7,"./modules/base-theme":8,"./modules/custom-chat/main":9,"./modules/halloween-theme":12,"./modules/history-states":13,"./modules/picture-map":14}],7:[function(e,t,n){const o=e("../util/env"),a=e("../util/settings");t.exports.main=async function(){if(!o.jklm.isRoom())return;const e=await o.jklm.waitForSocket();e.io.reconnection(!0);const t=unsafeWindow.disconnect;unsafeWindow.disconnect=()=>{},e.io.on("reconnect",(function(){const t=a.jklm.getSettings();e.emit("joinRoom",{roomCode:o.jklm.getRoomCode(),userToken:a.jklm.getUserToken(),nickname:t.nickname,auth:t.auth,picture:t.picture,language:navigator.language},(e=>{console.warn("[overlay] Re-connected to room"),"undefined"!=typeof socket_joinRoomCallback&&socket_joinRoomCallback(e)}))})),e.on("disconnect",(function(){console.warn("[overlay] Disconnected from room")})),e.on("kicked",(function(e){t(e)}))}},{"../util/env":15,"../util/settings":16}],8:[function(e,t,n){const o=e("../util/env");t.exports.main=async function(){GM_addStyle("\n    :root {\n      --primary-background-color: #7855c7;\n      --secondary-background-color: #445061;\n\n      --primary-color: #fff;\n\n      --primary-button-color: #26aa36;\n      --secondary-button-color: #3ba3ff;\n    }\n\n    button.styled, input.styled[type=radio] + label {\n      background: var(--primary-button-color);\n    }\n\n    button.styled.blue, input.styled[type=radio] + label {\n      background: var(--secondary-button-color) ;\n    }\n\n    button.styled:not(:disabled):hover, button.styled:not(:disabled):focus {\n      background: var(--primary-button-color);\n      filter: brightness(1.1);\n    }\n\n    button.styled.blue:not(:disabled):hover, button.styled.blue:not(:disabled):focus, input.styled[type=radio]:not(:checked) + label:hover {\n      background: var(--secondary-button-color);\n      filter: brightness(1.1);\n    }\n\n    input.styled[type=radio]:checked + label {\n      background: var(--secondary-button-color);\n      filter: brightness(0.9);\n    }\n  "),o.jklm.isHomepage()?GM_addStyle("\n      a[href] {\n        color: var(--primary-background-color);\n      }\n\n      body > div.base > div.top > h1 > a {\n        color: var(--primary-color);\n      }\n      \n      body {\n        background: var(--secondary-background-color);\n      }\n\n      .top {\n        background: var(--primary-background-color);\n        color: var(--primary-color);\n      }\n\n      .gameSelection input[type=radio]:checked + label {\n        background: var(--primary-background-color);\n      }\n\n    "):o.jklm.isRoom()&&GM_addStyle("\n      .top {\n        background: var(--primary-background-color);\n        color: var(--primary-color);\n      }\n\n      .sidebar .tabs a {\n        border-bottom: 0.25rem solid var(--secondary-background-color);\n      }\n\n      .sidebar .tabs a.active {\n        border-bottom-color: var(--primary-background-color);\n      }\n    ")}},{"../util/env":15}],9:[function(e,t,n){const o=e("../../util/env"),{createCustomChatPane:a,observeNormalChatPane:r}=e("./pane"),{listenToSocketEvents:s}=e("./socket-listeners"),i=e("../../elements/Chat"),c=e("../../elements/ChatInput"),l=e("../../elements/ChatMessageGroupEntry"),d=e("../../elements/ChatSystemEntry");t.exports.main=async function(){if(!o.jklm.isRoom())return;customElements.define("x-chat",i),customElements.define("x-chat-input",c),customElements.define("x-chat-message-group-entry",l),customElements.define("x-chat-system-entry",d);const e=document.querySelector(".pane.chat"),t=a(),n=t.querySelector("x-chat"),u=t.querySelector("x-chat-input");u.addEventListener("submit",(e=>{"undefined"!=typeof socket&&null!=socket&&socket.emit("chat",e.detail.value)})),r(e,{onVisible(){e.hidden=!0,t.hidden=!1}}),await s(n,u),e.hidden||(e.hidden=!0,t.hidden=!1)}},{"../../elements/Chat":1,"../../elements/ChatInput":3,"../../elements/ChatMessageGroupEntry":4,"../../elements/ChatSystemEntry":5,"../../util/env":15,"./pane":10,"./socket-listeners":11}],10:[function(e,t,n){t.exports.createCustomChatPane=function(){const e=document.createElement("template");e.innerHTML='\n    <div class="pane custom-chat" hidden>\n      <x-chat class="darkScrollbar"></x-chat>\n      <x-chat-input maxlength="300" placeholder="Type here to chat."></x-chat-input>\n    </div>\n  ';const t=e.content.querySelector(".pane");return document.querySelector(".sidebar").appendChild(e.content),GM_addStyle("\n    .pane.custom-chat {\n      display: flex;\n      flex-direction: column;\n    }\n\n    .pane.custom-chat x-chat {\n      flex: 1;\n      overflow-x: hidden;\n      overflow-y: auto;\n      padding: 0.25rem;\n    }\n\n    .pane.custom-chat x-chat-input {\n      height: 6rem;\n    }\n  "),t},t.exports.observeNormalChatPane=function(e,{onVisible:t}){new MutationObserver((function(n){for(const o of n)"hidden"===o.attributeName&&(e.hidden||t())})).observe(e,{attributes:!0})}},{}],11:[function(e,t,n){const o=e("../../util/env"),{pictureMap:a}=e("../picture-map"),r=e("../../elements/ChatSystemEntry"),s=e("../../elements/ChatMessageGroupEntry"),i=[],c=[];t.exports.listenToSocketEvents=async function(e,t){const n=await o.jklm.waitForSocket();let l=null;function d(){return e.scrollTop+e.clientHeight>e.scrollHeight-100}function u(){e.scroll(0,e.scrollHeight)}n.on("chat",((t,n)=>{const o=d();if(null==c[t.peerId]&&(c[t.peerId]=[],i[t.peerId]=[]),l?.profile.peerId!==t.peerId){const o=new s(t,a.get(t.peerId));l=o;const r=o.appendMessgae(n);i[t.peerId].push(o),c[t.peerId].push(r),e.appendEntry(o)}else{const e=l.appendMessgae(n);c[t.peerId].push(e)}o&&u()})),n.on("chatterAdded",(({nickname:t})=>{const n=d(),o=new r;l=null,o.style.setProperty("--color","#acff98"),o.textContent=`"${t}" joined the room`,e.appendEntry(o),n&&u()})),n.on("chatterRemoved",(({nickname:t})=>{const n=d(),o=new r;l=null,o.style.setProperty("--color","#ff9d98"),o.textContent=`"${t}" left the room`,e.appendEntry(o),n&&u()})),n.on("setChatMode",(n=>{const o=d(),a="undefined"==typeof settings||null==settings.auth,s="undefined"!=typeof selfRoles&&(selfRoles.includes("staff")||selfRoles.includes("creator"));let i="";switch(n){case"noGuests":e.disabled=a,t.disabled=a,i="Chat is now disabled for guests.";break;case"enabled":e.disabled=!1,t.disabled=!1,i="Chat is now enabled.";break;case"disabled":e.disabled=!s,t.disabled=!s,i="Chat is now disabled."}const c=new r;l=null,c.textContent=i,e.appendEntry(c),o&&u()})),n.on("setRoomPublic",(t=>{const n=d(),o=new r;l=null,o.textContent=t?"ðŸŒŽ The room is now public.":"ðŸ”’ The room is now private.",e.appendEntry(o),n&&u()})),n.on("userBanned",(({peerId:e})=>{if(null!=i[e]){for(const t of i[e])t.bannedAuthor=!0;for(const t of c[e])t.delete()}}))}},{"../../elements/ChatMessageGroupEntry":4,"../../elements/ChatSystemEntry":5,"../../util/env":15,"../picture-map":14}],12:[function(e,t,n){const o=e("../util/env");t.exports.main=async function(){const e=new Date;9===e.getMonth()&&(e.getDate()<20||(GM_addStyle("\n    :root {\n      --primary-background-color: #c16525 !important;\n      --secondary-background-color: #445061;\n\n      --primary-color: #fff !important;\n\n      --primary-button-color: #c16525 !important;\n      --secondary-button-color: #c16525 !important;\n    }\n  "),o.jklm.isHomepage()&&GM_addStyle("\n      .banner {\n        filter: grayscale(1);\n      }\n    ")))}},{"../util/env":15}],13:[function(e,t,n){const o=e("../util/env");t.exports.main=async function(){if(o.jklm.isHomepage()){const e=document.querySelector(".page.home"),t=document.querySelector(".page.auth"),n=document.querySelector("button.auth");window.addEventListener("popstate",(n=>{t.hidden="auth"!==n.state?.page,e.hidden="auth"===n.state?.page})),n.addEventListener("click",(function(){t.hidden&&history.pushState({page:"auth"},"")}))}else if(o.jklm.isRoom()){const e=document.querySelector(".pane.chat"),t=document.querySelector(".pane.room"),n=document.querySelector(".pane.userProfile"),o=document.querySelector(".tabs .chat"),a=document.querySelector(".tabs .room"),r=function(){history.pushState({pane:this===a?"room":"chat"},"")};window.addEventListener("popstate",(o=>{e.hidden="room"===o.state?.pane,t.hidden="room"!==o.state?.pane,n.hidden=!0})),o.addEventListener("click",r),a.addEventListener("click",r)}}},{"../util/env":15}],14:[function(e,t,n){const o=e("../util/env"),a=new Map;t.exports.pictureMap=a,t.exports.main=async function(){if(!o.jklm.isRoom())return;const e=await o.jklm.waitForSocket();let t=0;function n(){e.emit("getChatterProfiles",(e=>{a.clear();for(const t of e)a.set(t.peerId,t.picture)}))}e.on("setPlayerCount",(e=>{t=e,e<t||n()})),n()}},{"../util/env":15}],15:[function(e,t,n){const o={},a=new Promise((async(e,t)=>{for(let t=0;t<20;t++){if("undefined"!=typeof socket&&null!=socket&&socket.connected)return e(socket);await new Promise((e=>setTimeout(e,200)))}t("Undefined socket")}));o.jklm={isHomepage:()=>"jklm.fun"===location.host&&"/"===location.pathname,isRoom:()=>"jklm.fun"===location.host&&(5===location.pathname.length&&"/faq/"!==location.pathname),getRoomCode(){return this.isRoom()?location.pathname.slice(1).toUpperCase():null},isGame:()=>!!location.host.endsWith(".jklm.fun")&&!!location.pathname.startsWith("/games/"),getGameName(){return this.isGame()?location.pathname.slice(7):null},waitForSocket:()=>a},t.exports=o},{}],16:[function(e,t,n){const o={};o.jklm={getUserToken:()=>localStorage.getItem("jklmUserToken"),getSettings:()=>JSON.parse(localStorage.getItem("jklmSettings"))},t.exports=o},{}]},{},[6]);
